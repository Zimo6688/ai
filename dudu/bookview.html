<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹¦ç±ç­›é€‰</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue/dist/index.iife.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        #log {
            .log-container {
                margin-top: 20px;
                padding: 15px;
                background: #2b2b2b;
                color: #e6e6e6;
                border-radius: 6px;
                font-family: monospace;
                white-space: pre-wrap;
            word-break: break-all;
                max-height: 300px;
                overflow-y: auto;
            }
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .filter-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        .filter-group {
            margin-bottom: 15px;
        }
        .filter-group label {
            font-weight: bold;
            margin-right: 10px;
        }
        .el-select {
    --el-select-border-radius: 8px;
    --el-select-input-focus-border-color: #409EFF;
    --el-select-height: 40px;
    min-width: 220px;
    margin: 8px 0;
}

.el-select__wrapper {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.el-select__wrapper:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12) !important;
}

.el-col {
    margin-bottom: 16px;
}
        .books-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            padding: 12px;
        }
        .book-card {
            text-align: left;
            padding: 16px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #fff;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        
        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        
        .book-card img {
            width: 100%;
            height: 240px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 16px;
            transition: transform 0.3s ease;
        }
        
        .book-card:hover img {
            transform: scale(1.02);
        }
        
        .book-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .book-info {
            color: #5c6b7a;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .book-info p {
            margin: 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .book-info strong {
            color: #34495e;
            font-weight: 500;
            min-width: 60px;
        }
        
        .book-description {
            font-size: 14px;
            color: #64748b;
            line-height: 1.6;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }
        
        .book-description strong {
            color: #34495e;
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .books-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .books-grid {
                grid-template-columns: 1fr;
            }
        }
        .book-title {
            font-size: 16px;
            color: #333;
        }
        .back-to-top {
            position: fixed;
            right: 20px;
            bottom: 80px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #409EFF;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
            z-index: 1000;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
        }
        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }
        .back-to-top:hover {
            background-color: #66b1ff;
            transform: translateY(-2px);
        }
        .log-button {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #67C23A;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
        }
        .log-button:hover {
            background-color: #85ce61;
            transform: translateY(-2px);
        }
        .log-dialog .el-dialog__body {
            padding: 0;
            max-height: 70vh;
            overflow-y: auto;
        }
        .log-container {
            padding: 15px;
            background: #2b2b2b;
            color: #e6e6e6;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
        <div class="filter-section">
    <el-row :gutter="20" class="flex flex-wrap gap-4">
        <el-col :xs="24" :sm="12" :md="6" class="flex items-center gap-2">
            <span class="text-gray-600 font-medium">ç³»åˆ—ï¼š</span>
            <el-select v-model="filterForm.series" placeholder="å…¨éƒ¨ç³»åˆ—" filterable clearable>
                <el-option v-for="item in seriesOptions" :key="item.tid" :label="item.name" :value="item.tid" />
            </el-select>
        </el-col>
            <el-col :xs="24" :sm="12" :md="6" class="flex items-center gap-2">
            <span class="text-gray-600 font-medium">å¹´çº§ï¼š</span>
            <el-select v-model="filterForm.grade" placeholder="å…¨éƒ¨å¹´çº§" filterable clearable>
                <el-option v-for="item in gradeOptions" :key="item.tid" :label="item.name" :value="item.tid" />
            </el-select>
        </el-col>
            <el-col :xs="24" :sm="12" :md="6" class="flex items-center gap-2">
            <span class="text-gray-600 font-medium">çº§åˆ«ï¼š</span>
            <el-select v-model="filterForm.level" placeholder="å…¨éƒ¨çº§åˆ«" filterable clearable>
                <el-option v-for="item in levelOptions" :key="item.tid" :label="item.name" :value="item.tid" />
            </el-select>
        </el-col>
            <el-col :xs="24" :sm="12" :md="6" class="flex items-center gap-2">
            <span class="text-gray-600 font-medium">ä¸»é¢˜ï¼š</span>
            <el-select v-model="filterForm.theme" placeholder="å…¨éƒ¨ä¸»é¢˜" filterable clearable>
                <el-option v-for="item in themeOptions" :key="item.tid" :label="item.name" :value="item.tid" />
            </el-select>
        </el-col>
            <el-col :span="24" class="mt-4" style="text-align: right;">
            <el-button 
                type="primary" 
                @click="handleSearch"
                class="w-full md:w-auto px-8"
                >ç«‹å³æŸ¥è¯¢</el-button>
        </el-col>
    </el-row>
        </div>
        <div class="books-grid">
            <div v-for="book in books" :key="book.id" class="book-card">
                <img :src="book.cover" :alt="book.name">
                <div class="book-title">{{ book.name }}</div>
                <div class="book-title" style="font-style: italic; margin-bottom: 10px;">{{ book.en_name || 'æ— ' }}</div>
                <div class="book-info">
                    <p><strong>çº§åˆ«ï¼š</strong>{{ book.level || 'æ— ' }}</p>
                    <p><strong>è¯æ±‡é‡ï¼š</strong>{{ book.vocabulary_size || 'æ— ' }}</p>
                    <p><strong>è“æ€å€¼ï¼š</strong>{{ book.lexile_score || 'æ— ' }}</p>
                    <p><strong>ç±»å‹ï¼š</strong>{{ book.genre || 'æ— ' }}</p>
                </div>
                <div class="book-description"><strong>ä»‹ç»ï¼š</strong>{{ book.description || 'æš‚æ— æè¿°' }}</div>
            </div>
        </div>
        <div v-if="loading" class="loading-container" style="text-align: center; padding: 20px;">
            <el-icon class="is-loading" style="font-size: 24px; margin-right: 8px;"><Loading /></el-icon>
            <span>åŠ è½½ä¸­...</span>
        </div>
        <div v-if="!loading && !hasMore" class="loading-container" style="text-align: center; padding: 20px;">
            <span>æ²¡æœ‰æ›´å¤šçš„æ•°æ®äº†</span>
        </div>
    </div>
    <div class="back-to-top" :class="{ show: showBackToTop }" @click="scrollToTop">
        <span style="font-size: 24px;">â†‘</span>
    </div>
    <div class="log-button" @click="showLogDialog = true">
        <span style="font-size: 24px;">ğŸ“‹</span>
    </div>
    <el-dialog
        v-model="showLogDialog"
        title="è°ƒç”¨æ—¥å¿—"
        width="80%"
        class="log-dialog"
        :close-on-click-modal="false"
    >
        <div class="log-container">
            <div v-for="(entry, index) in logs" :key="index" :style="{ color: logColors[entry.type] }">
                [{{ entry.timestamp }}] {{ entry.message }}
            </div>
        </div>
    </el-dialog>
    </div>
    <script>
        const { createApp } = Vue;
        const app = createApp({
            data() {
                return {
                    showLogDialog: false,
                    filterForm: {
                        series: null,
                        grade: null,
                        level: null,
                        theme: null
                    },
                    showBackToTop: false,
                    seriesOptions: [],
                    gradeOptions: [],
                    levelOptions: [],
                    themeOptions: [],
                    books: [],
                    logs: [],
                    logColors: {
                        info: '#e6e6e6',
                        success: '#69db7c',
                        error: '#ff6b6b',
                        warning: '#ffd43b'
                    },
                    currentPage: 1,
                    totalBooks: 0,
                    pageSize: 18,
                    showBackToTop: false,
                    loading: false,
                    hasMore: true
                }
            },
            async mounted() {
                await this.fetchOptions();
                this.log('ğŸŸ¢ é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œå·²åŠ è½½åˆ†ç±»é€‰é¡¹');
                this.fetchBooks(); // åˆå§‹åŒ–æ—¶åŠ è½½é»˜è®¤ä¹¦ç±
                window.addEventListener('scroll', this.handleScroll);
            },
            unmounted() {
                window.removeEventListener('scroll', this.handleScroll);
            },
            methods: {
                scrollToTop() {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                },
                handleScroll() {
                    this.showBackToTop = window.scrollY > 300;
                    
                    // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨
                    if (!this.loading) {
                        const scrollHeight = document.documentElement.scrollHeight;
                        const scrollTop = window.scrollY || document.documentElement.scrollTop;
                        const clientHeight = document.documentElement.clientHeight;
                        
                        if (scrollTop + clientHeight >= scrollHeight - 100) {
                            this.loadMore();
                        }
                    }
                },
                scrollToTop() {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                },
                handleSearch() {
                    this.currentPage = 1;
                    this.hasMore = true;
                    this.fetchBooks();
                },
                log(message, type = 'info') {
                    const timestamp = new Date().toLocaleTimeString();
                    this.logs.unshift({
                        message,
                        type,
                        timestamp
                    });
                    // ä¿æŒæ—¥å¿—æ¡ç›®ä¸è¶…è¿‡50æ¡
                    if(this.logs.length > 50) this.logs.pop();
                },
                async fetchOptions() {
                    try {
                        const response = await fetch('https://api.bubble.shenmo-ai.net/books-options');
                        const data = await response.json();
                        // ç§»é™¤æ¯ä¸ªåˆ†ç±»çš„ç¬¬ä¸€ä¸ªé€‰é¡¹ï¼ˆå…¨éƒ¨xxxï¼‰
                        this.seriesOptions = data.data.series.slice(1);
                        this.gradeOptions = data.data.grade.slice(1);
                        this.levelOptions = data.data.level.slice(1);
                        this.themeOptions = data.data.theme.slice(1);
                    } catch (error) {
                        console.error('è·å–ç­›é€‰é€‰é¡¹å¤±è´¥:', error);
                        this.log(`âŒ è·å–é€‰é¡¹å¤±è´¥: ${error.message}`, 'error');
                    }
                },
                async fetchBooks(isLoadMore = false) {
                    this.loading = true;
                    try {
                        // æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„tidå€¼
                        const selectedTids = Object.values(this.filterForm)
                            .filter(val => val !== null && val !== undefined)
                            .join(',');
                        
                        const queryParams = `page=${this.currentPage}&size=${this.pageSize}${selectedTids ? `&tids=${selectedTids}` : ''}`;
                        const fullUrl = `https://api.bubble.shenmo-ai.net/books?${queryParams}`;
                        this.log(`ğŸŒ è¯·æ±‚URL: ${fullUrl}`, 'info');
                        
                        const response = await fetch(fullUrl);
                        const data = await response.json();
                        
                        // æ›´æ–°æ€»æ•°å’Œåˆ†é¡µä¿¡æ¯
                        this.totalBooks = data.total_count || 0;
                        
                        if (!data.data || data.data.length === 0) {
                            if (isLoadMore) {
                                this.hasMore = false;
                                this.log('ğŸ“Š æ²¡æœ‰æ›´å¤šæ•°æ®äº†', 'warning');
                            } else {
                                this.books = [];
                                this.log('ğŸ“Š æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•°æ®', 'warning');
                            }
                            return;
                        }
                        
                        if (isLoadMore) {
                            // è¿½åŠ æ–°æ•°æ®åˆ°ç°æœ‰åˆ—è¡¨
                            this.books = [...this.books, ...data.data];
                            this.log(`ğŸ“Š æˆåŠŸåŠ è½½ç¬¬${this.currentPage}é¡µæ•°æ®ï¼Œè·å–åˆ°${data.data.length}æ¡è®°å½•`, 'success');
                        } else {
                            // é‡ç½®åˆ—è¡¨å¹¶æ˜¾ç¤ºæ–°æ•°æ®
                            this.books = data.data;
                            this.hasMore = true;
                            this.log(`ğŸ“Š é‡ç½®æ•°æ®ï¼Œå½“å‰ç¬¬${this.currentPage}é¡µï¼Œæ€»è®°å½•æ•°${this.totalBooks}æ¡`, 'success');
                        }
                    } catch (error) {
                        console.error('æŸ¥è¯¢å¤±è´¥:', error);
                        this.log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                loadMore() {
                    if (!this.loading && this.hasMore) {
                        this.currentPage += 1;
                        this.log(`ğŸ“„ æ­£åœ¨åŠ è½½ç¬¬${this.currentPage}é¡µæ•°æ®...`, 'info');
                        this.fetchBooks(true);
                    }
                },
                handlePageChange(page) {
                    this.currentPage = page;
                    this.fetchBooks();
                    this.log(`ğŸ“„ åˆ‡æ¢åˆ°ç¬¬${page}é¡µ`);
                }
            }
        })
        .use(ElementPlus).mount('#app');
    </script>
</body>
</html>